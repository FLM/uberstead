#!/usr/bin/env php
<?php
use Symfony\Component\Console\Application;
use Symfony\Component\Finder\Finder;
use Symfony\Component\Console\Command\Command;
use Uberstead\Command\BaseCommand;
use Uberstead\Container\Container;
use Uberstead\Service\ValidatorService;

set_time_limit(0);
require_once "vendor/autoload.php";

/*
 * Setup Container
 */
$container = new Container();
$container['validator'] = new ValidatorService();

/*
 * Load Commands
 */
$finder = new Finder();
$commandFiles = $finder->files()
    ->name('*Command.php')
    ->notName('*BaseCommand.php')
    ->notName('CheckConfigCommand.php')
    ->in('src')
;

$commands = array();
foreach ($commandFiles as $file) {
    if (preg_match('#^namespace\s+(.+?);.*class\s+(\w+).+;$#sm', $file->getContents(), $m)) {
        $class = $m[1].'\\'.$m[2];
        $object = new $class();
        if ($object instanceof BaseCommand) {
            /** @var BaseCommand $object */
            $commands[] = $object;
            $object->setContainer($container);
        }
    }
}

//---------------------------
// Run Application
//---------------------------
$console = new Application();
$console->addCommands($commands);
$console->run();
